# ESP32 건조기 컨트롤러 사용 설명서

## 목차
1. [시스템 개요](#시스템-개요)
2. [하드웨어 사양](#하드웨어-사양)
3. [작동 방법](#작동-방법)
4. [상태 표시](#상태-표시)
5. [에러 코드](#에러-코드)
6. [펌웨어 업데이트](#펌웨어-업데이트)
7. [설정 변경](#설정-변경)

---

## 시스템 개요

ESP32 기반 건조기 자동 제어 시스템으로 온도, 시간, 댐퍼를 제어하며 WiFi/MQTT를 통한 원격 모니터링을 지원합니다.

### 주요 기능
- **자동 온도 제어**: NTC 센서 기반 히터 온/오프 제어 (±0.5℃ 히스테리시스)
- **타이머 기능**: 30분 단위 설정 (최대 12,000분)
- **자동 냉각**: 건조 완료 후 5분간 팬 냉각
- **댐퍼 자동/수동 제어**: 히터 연동 자동 개폐
- **에러 감지**: NTC 센서, 과열, 팬 이상 감지
- **WiFi/MQTT**: 원격 모니터링 및 제어
- **OTA 업데이트**: 무선 펌웨어 업데이트
- **정전 복구**: Flash 메모리에 상태 저장

---

## 하드웨어 사양

### 핀 연결
| 기능 | 핀 번호 | 설명 |
|------|---------|------|
| **출력** |
| FAN | GPIO 18 | 팬 제어 (릴레이) |
| HEATER | GPIO 5 | 히터 제어 (릴레이) |
| DAMPER | GPIO 19 | 댐퍼 모터 제어 |
| BEEP | GPIO 22 | 부저 (에러 알림) |
| **입력** |
| NTC1 | GPIO 36 | 메인 온도 센서 (ADC) |
| SHT30_T | GPIO 32 | 습도 센서 온도 (ADC) |
| SHT30_H | GPIO 35 | 습도 센서 습도 (ADC) |
| FAN_CURRENT | GPIO 39 | 팬 전류 감시 (ADC) |
| OVERHEAT | GPIO 26 | 과열 감지 (디지털) |
| **디스플레이** |
| FND_STB | GPIO 27 | TM1638 STB |
| FND_CLK | GPIO 14 | TM1638 CLK |
| FND_DIO | GPIO 15 | TM1638 DIO |

### 센서 사양
- **NTC 온도 센서**: 5KΩ @ 25℃, Beta=3970
- **풀업 저항**: 5KΩ
- **전원**: 3.3V
- **온도 범위**: -20℃ ~ 199℃

---

## 작동 방법

### 1. 전원 켜기
1. 전원 투입 시 FND에 "H2FI0003" (펌웨어 버전) 3초간 표시
2. 자동으로 정상 화면으로 전환

### 2. 키 기능

#### **KEY_PWR (전원 버튼)**
- **짧게 누름 (1초 이내)**: 전원 ON/OFF 토글
  - Power OFF → ON: 저장된 시간 확인 후 자동 시작
  - Power ON → OFF: 즉시 정지 (히터/팬 OFF)
- **길게 누름 (3초)**: WiFi SmartConfig 모드 진입

#### **KEY_TEMP_UP / KEY_TEMP_DN (온도 설정)**
- 설정 온도 1℃ 단위 증감
- 범위: 0℃ ~ 70℃
- 3초 후 자동으로 Flash에 저장

#### **KEY_TIME_UP / KEY_TIME_DN (시간 설정)**
- 30분 단위 증감 (자동 정렬)
- 범위: 0분 ~ 12,000분 (200시간)
- 시간 설정 시 자동으로 DRY_RUN 상태로 전환
- 3초 후 자동으로 Flash에 저장

#### **KEY_DAMPER (댐퍼 모드)**
- 자동/수동 모드 토글
- **자동 모드**: 히터 ON 시 댐퍼 닫힘, 히터 OFF 시 댐퍼 열림
- **수동 모드**: 댐퍼 항상 열림

### 3. 운전 상태

#### **DRY_RUN (건조 운전)**
- 히터: 온도 제어 (설정온도 ±0.5℃)
- 팬: 부팅 2초 후 자동 시작, 계속 ON
- 댐퍼: 자동 모드 시 히터 연동
- 시간: 1분마다 카운트다운
- 종료 조건: 시간 00:00 도달 → DRY_COOL로 전환

#### **DRY_COOL (냉각 모드)**
- 히터: OFF
- 팬: ON (5분간 냉각)
- 댐퍼: 열림
- 종료 조건: 5분 경과 → DRY_FINISH로 전환

#### **DRY_FINISH (완료)**
- 히터: OFF
- 팬: OFF
- 댐퍼: 열림
- 시간 추가 시 자동으로 DRY_RUN으로 전환

### 4. 정전 복구
- Flash 메모리에 상태 저장 (온도, 시간, 댐퍼, 전원 상태)
- 전원 복구 시 저장된 상태로 복원
- 냉각 중(DRY_COOL) 정전 시 → 완료(DRY_FINISH)로 전환

---

## 상태 표시

### FND 디스플레이 (8자리)
```
[현재온도] [설정온도] [시:분]
  38        45       01:30
```

- **자리 1-2**: 현재 온도 (NTC 센서)
- **자리 3-4**: 설정 온도
- **자리 5-8**: 남은 시간 (시:분)
- **점(.)**: 1초마다 깜빡임

### LED 표시
| LED | 의미 |
|-----|------|
| HEATER | 히터 동작 중 |
| FAN | 팬 동작 중 |
| NETWORK | WiFi 연결 |
| DAMPER_AUTO | 댐퍼 자동 모드 |
| DAMPER_OPEN | 댐퍼 열림 |
| DAMPER_CLOSE | 댐퍼 닫힘 |

### 특수 표시

#### **부팅**
```
H2FI0003  (3초간 표시)
```

#### **SmartConfig 대기**
```
SC__0000  (깜빡임)
```

#### **SmartConfig 완료**
```
SC__DonE  (3초간 표시)
```

#### **MQTT ID 수신**
```
  123456  (수신된 ID, 3초간 표시)
```

---

## 에러 코드

에러 발생 시:
- FND에 에러 코드 표시
- 히터/팬 자동 OFF
- 댐퍼 자동 열림
- 1초마다 부저 울림

| 코드 | 원인 | 조치 |
|------|------|------|
| **E1** | 팬 에러 | 팬 전류 이상, 팬 연결 확인 |
| **E2** | 히터 에러 | 히터 회로 이상 |
| **E3** | NTC 단선 | 센서 연결 확인 (전압 > 3.0V) |
| **E4** | NTC 단락 | 센서 연결 확인 (전압 < 0.2V) |
| **E5** | 과열 감지 | PIN_OH 감지, 냉각 후 재시작 |
| **HI** | 고온 에러 | 온도 > 설정값 초과 |
| **E7** | 메모리 에러 | Flash 메모리 이상 |

### 에러 해제
- 에러 원인 제거 후 자동 복구
- 또는 전원 OFF/ON

---

## 펌웨어 업데이트

### 방법 1: OTA (무선 업데이트)

#### Arduino IDE
1. ESP32가 WiFi 연결 상태 확인
2. 도구 → 포트 → "DryerESP32 at 192.168.x.x" 선택
3. 업로드 버튼 클릭
4. 비밀번호 입력: `1234`

#### PlatformIO
```powershell
# platformio.ini에 설정
upload_protocol = espota
upload_port = 192.168.x.x
upload_flags = --auth=1234

# 업로드
pio run --target upload
```

#### 직접 명령
```powershell
python -m espota -i 192.168.x.x -p 3232 -a 1234 -f firmware.bin
```

### 방법 2: USB 케이블

#### esptool.py
```powershell
# 설치
pip install esptool

# 업로드 (COM 포트는 장치 관리자에서 확인)
esptool.py --chip esp32 --port COM3 --baud 921600 write_flash 0x10000 firmware.bin
```

#### ESP Flash Download Tool
1. Espressif 공식 도구 다운로드
2. GUI로 간편 업로드
3. https://www.espressif.com/en/support/download/other-tools

---

## 설정 변경

### WiFi 설정

#### 방법 1: config.h 파일 수정 (컴파일 전)
```cpp
#define WIFI_SSID       "your_wifi_name"
#define WIFI_PASS       "your_wifi_password"
```

#### 방법 2: SmartConfig (현장 설정)
1. KEY_PWR 버튼 3초 길게 누름
2. FND에 "SC__0000" 표시 (깜빡임)
3. 스마트폰 앱 사용:
   - Android: "ESP Touch" 앱
   - iOS: "ESP Touch" 앱
4. 앱에서 WiFi 정보 입력 및 전송
5. 연결 완료 시 "SC__DonE" 표시

### MQTT 설정

#### Broker 설정 (mqtt/mqttClient.h)
```cpp
#define MQTT_SERVER     "your_mqtt_server"
#define MQTT_PORT       1883
#define MQTT_USER       "username"
#define MQTT_PASS       "password"
```

#### Topic 구조
- **상태 전송**: `yc_dry/pub/[MAC주소]/status`
- **명령 수신**: `yc_dry/sub/[MAC주소]/cmd`
- **데이터 전송**: `yc_dry/pub/[MAC주소]/data`

#### MQTT 명령
| Topic Suffix | 명령 | 예시 | 설명 |
|--------------|------|------|------|
| `/cmd` | JST | `JST:45` | 온도 설정 (℃) |
| `/cmd` | JSP | `JSP:90` | 시간 설정 (분) |

### OTA 설정 (config.h)
```cpp
#define OTA_HOSTNAME    "DryerESP32"    // 네트워크에서 보이는 이름
#define OTA_PASSWORD    "1234"          // OTA 업로드 비밀번호
```

### 온도 제어 파라미터 (config.h)
```cpp
#define HEATER_HYSTERESIS   0.5f    // 히터 히스테리시스 (±℃)
#define COOLING_TIME        5       // 냉각 시간 (분)
```

### NTC 센서 파라미터 (config.h)
```cpp
#define NTC_PULL_RES    5000.0f   // 풀업 저항 (Ω)
#define NTC_BETA        3970.0f   // Beta 값
#define NTC_R25         5000.0f   // 25℃ 저항 (Ω)
```

---

## 문제 해결

### WiFi 연결 안됨
1. SmartConfig로 재설정
2. 라우터 2.4GHz 대역 확인 (5GHz 지원 안함)
3. SSID에 특수문자 확인

### OTA 업데이트 실패
1. WiFi 연결 상태 확인
2. 같은 네트워크에 있는지 확인
3. 방화벽 확인 (포트 3232)
4. 비밀번호 확인 (기본: 1234)

### 온도 센서 에러
1. NTC 센서 연결 확인
2. 풀업 저항 확인 (5KΩ)
3. 센서 단선/단락 확인
4. 에러 코드 E3/E4 참조

### 디스플레이 표시 안됨
1. TM1638 연결 확인 (STB, CLK, DIO)
2. 전원 확인 (5V)
3. 밝기 설정 확인

---

## 기술 사양

### 시스템
- **MCU**: ESP32 (240MHz, 320KB RAM, 4MB Flash)
- **WiFi**: 802.11 b/g/n (2.4GHz)
- **프레임워크**: Arduino ESP32 6.12.0
- **RTOS**: FreeRTOS

### 센서
- **온도 측정**: NTC 5KΩ (Beta 3970)
- **온도 범위**: -20℃ ~ 199℃
- **온도 정밀도**: ±0.5℃
- **ADC 분해능**: 12-bit (0-4095)
- **ADC 필터**: 지수 이동 평균 (α=0.01)

### 제어
- **온도 제어**: ON/OFF 제어 (히스테리시스 ±0.5℃)
- **제어 주기**: 1초
- **타이머 분해능**: 1분
- **냉각 시간**: 5분 (고정)
- **팬 시작 지연**: 2초 (부팅 시)

### 통신
- **MQTT 프로토콜**: v3.1.1
- **데이터 전송 주기**: 5분
- **OTA 프로토콜**: HTTP
- **OTA 포트**: 3232

---

## 유지보수

### 정기 점검 (월 1회)
- [ ] NTC 센서 연결 상태
- [ ] 릴레이 동작 확인
- [ ] 팬 전류 확인
- [ ] 과열 센서 동작 확인
- [ ] 댐퍼 동작 확인

### Flash 메모리 수명
- 쓰기 횟수: 약 100,000회
- 예상 수명: 10년 이상 (1일 10회 저장 기준)

### 펌웨어 버전 확인
- 부팅 시 FND에 표시: "H2TT0002"
- 시리얼 로그: 115200 baud

---

## 연락처

**기술 지원**
- 개발자: [연락처]
- 펌웨어 버전: H2TT0002
- 문서 버전: 1.0
- 최종 수정: 2025-12-01

---

## 라이센스 및 고지사항

본 제품은 ESP32 Arduino Core를 기반으로 제작되었습니다.

**사용된 라이브러리:**
- Arduino ESP32 Core (LGPL-2.1)
- PubSubClient (MIT)
- ArduinoOTA (LGPL-2.1)
- Preferences (LGPL-2.1)
- WiFi (LGPL-2.1)

**안전 주의사항:**
- 전기 안전 규정 준수
- 과부하 방지
- 정격 전압/전류 확인
- 환기 상태 유지
